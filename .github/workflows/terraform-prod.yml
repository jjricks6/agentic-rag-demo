name: Terraform Prod Environment

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/environments/prod/**'
      - 'terraform/modules/**'
      - '.github/workflows/terraform-prod.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/environments/prod/**'
      - 'terraform/modules/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  terraform-plan:
    name: Terraform Plan (Prod)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform/environments/prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Create Lambda placeholder
        run: |
          echo 'def handler(event, context): return {"statusCode": 200}' > lambda_placeholder.py
          zip lambda-placeholder.zip lambda_placeholder.py
          rm lambda_placeholder.py

      - name: Generate backend config
        run: |
          set -e

          # Query AWS directly for backend resources (more reliable than Terraform outputs)
          echo "ðŸ” Looking for Terraform backend resources in AWS..."

          # Find S3 bucket with terraform state
          BUCKET_NAME=$(aws s3api list-buckets --query "Buckets[?contains(Name, 'agentic-rag-demo-tfstate')].Name | [0]" --output text)

          if [ "$BUCKET_NAME" == "None" ] || [ -z "$BUCKET_NAME" ]; then
            echo "âŒ ERROR: Backend S3 bucket not found!"
            echo ""
            echo "Please deploy the backend first:"
            echo "1. Go to Actions tab"
            echo "2. Select 'Terraform Backend Setup' workflow"
            echo "3. Click 'Run workflow' and wait for completion"
            echo ""
            exit 1
          fi

          # Find DynamoDB table for state locking
          TABLE_NAME=$(aws dynamodb list-tables --query "TableNames[?contains(@, 'agentic-rag-demo-tfstate-lock')] | [0]" --output text)

          if [ "$TABLE_NAME" == "None" ] || [ -z "$TABLE_NAME" ]; then
            echo "âŒ ERROR: Backend DynamoDB table not found!"
            echo ""
            echo "Backend may not be fully deployed. Please check the backend deployment."
            exit 1
          fi

          # Generate backend config
          cat > backend.hcl <<EOF
          bucket         = "$BUCKET_NAME"
          key            = "prod/terraform.tfstate"
          region         = "${{ env.AWS_REGION }}"
          dynamodb_table = "$TABLE_NAME"
          encrypt        = true
          EOF

          echo "âœ… Backend config generated successfully"
          echo "Bucket: $BUCKET_NAME"
          echo "Table: $TABLE_NAME"

      - name: Terraform Init
        run: terraform init -backend-config=backend.hcl

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -out=prod.tfplan
          terraform show -no-color prod.tfplan > plan-output.txt

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/environments/prod/plan-output.txt', 'utf8');
            const maxLength = 65000;
            const truncatedPlan = plan.length > maxLength
              ? plan.substring(0, maxLength) + '\n\n...[Plan truncated due to length]'
              : plan;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ Terraform Production Environment Plan\n\n**IMPORTANT**: This plan will affect production resources!\n\n\`\`\`terraform\n${truncatedPlan}\n\`\`\``
            });

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: prod-tfplan
          path: terraform/environments/prod/prod.tfplan
          retention-days: 5

  terraform-apply:
    name: Terraform Apply (Prod) - Requires Approval
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
    environment:
      name: production
      url: https://console.aws.amazon.com/bedrock
    defaults:
      run:
        working-directory: terraform/environments/prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Create Lambda placeholder
        run: |
          echo 'def handler(event, context): return {"statusCode": 200}' > lambda_placeholder.py
          zip lambda-placeholder.zip lambda_placeholder.py
          rm lambda_placeholder.py

      - name: Generate backend config
        run: |
          set -e

          # Query AWS directly for backend resources (more reliable than Terraform outputs)
          echo "ðŸ” Looking for Terraform backend resources in AWS..."

          # Find S3 bucket with terraform state
          BUCKET_NAME=$(aws s3api list-buckets --query "Buckets[?contains(Name, 'agentic-rag-demo-tfstate')].Name | [0]" --output text)

          if [ "$BUCKET_NAME" == "None" ] || [ -z "$BUCKET_NAME" ]; then
            echo "âŒ ERROR: Backend S3 bucket not found!"
            echo ""
            echo "Please deploy the backend first:"
            echo "1. Go to Actions tab"
            echo "2. Select 'Terraform Backend Setup' workflow"
            echo "3. Click 'Run workflow' and wait for completion"
            echo ""
            exit 1
          fi

          # Find DynamoDB table for state locking
          TABLE_NAME=$(aws dynamodb list-tables --query "TableNames[?contains(@, 'agentic-rag-demo-tfstate-lock')] | [0]" --output text)

          if [ "$TABLE_NAME" == "None" ] || [ -z "$TABLE_NAME" ]; then
            echo "âŒ ERROR: Backend DynamoDB table not found!"
            echo ""
            echo "Backend may not be fully deployed. Please check the backend deployment."
            exit 1
          fi

          # Generate backend config
          cat > backend.hcl <<EOF
          bucket         = "$BUCKET_NAME"
          key            = "prod/terraform.tfstate"
          region         = "${{ env.AWS_REGION }}"
          dynamodb_table = "$TABLE_NAME"
          encrypt        = true
          EOF

          echo "âœ… Backend config generated successfully"
          echo "Bucket: $BUCKET_NAME"
          echo "Table: $TABLE_NAME"

      - name: Terraform Init
        run: terraform init -backend-config=backend.hcl

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: prod-tfplan
          path: terraform/environments/prod

      - name: Terraform Apply
        run: terraform apply -auto-approve prod.tfplan

      - name: Save outputs
        run: |
          terraform output -json > ../../../agent-config-prod.json
          echo "### Production Environment Deployed! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **PRODUCTION DEPLOYMENT COMPLETE**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Agent ID: $(terraform output -raw agent_id)" >> $GITHUB_STEP_SUMMARY
          echo "Documents Bucket: $(terraform output -raw documents_bucket_name)" >> $GITHUB_STEP_SUMMARY
          echo "Vectors Bucket: $(terraform output -raw vectors_bucket_name)" >> $GITHUB_STEP_SUMMARY

      - name: Upload config artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-config-prod
          path: agent-config-prod.json
          retention-days: 90
